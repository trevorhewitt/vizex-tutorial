<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1"
  />
  <title>XX — Template</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <style>
    /* Keep the original look/spacing */
    .page { max-width: 900px; margin: 0 auto; padding: 24px; }
    .wait-wrap { margin-top:16px; }
    .footer { position: fixed; left: 0; right: 0; bottom: 0; padding: 12px 16px; }
    .button-bar { display: flex; gap: 12px; justify-content: space-between; }

    /* Make taps crisp and avoid selection/callouts on iOS */
    html, body {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      touch-action: manipulation; /* reduces dbl-tap zoom behavior */
    }

    /* Invisible gesture zones (do NOT affect layout) */
    .tap-zone {
      position: fixed;
      left: 0; right: 0;
      background: transparent; /* fully invisible */
      z-index: 9999;           /* above content, but not visible */
    }
    .tap-top    { top: 0;    height: 45vh; }
    .tap-bottom { bottom: 0; height: 45vh; }

    /* Ensure the zones never show a cursor change */
    .tap-zone, .tap-zone * { cursor: default; }
  </style>
</head>
<body data-page="xx-template">
  <!-- Invisible tap zones for the ABAB gesture -->
  <div class="tap-zone tap-top" aria-hidden="true"></div>
  <div class="tap-zone tap-bottom" aria-hidden="true"></div>

  <div class="page">
    <div class="content">
      <div class="inner">
        <h1>You have now completed the practice trials. </h1>
        <p>Well done</p>

        <div class="wait-wrap" style="margin-top:16px;">
          <h1>WAIT</h1>
        </div>
        <p>Please wait a moment for the rest of the participants to finish as well.</p>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="button-bar">
      <button id="backBtn" class="secondary">Back</button>
      <button id="nextBtn" class="primary">Next</button>
    </div>
  </div>

  <script>
    // ============================
    // EDIT THESE THREE CONSTANTS:
    // ============================
    const NEXT_PAGE = "XX_set_next.html";
    const BACK_PAGE = "XX_set_back.html";
    // ============================

    // --- Shared helpers (inline, no external deps) ---
    function parseQuery() {
      const q = new URLSearchParams(location.search);
      return Object.fromEntries(q.entries());
    }
    function baseQueryString() {
      const { p, n, m } = parseQuery();
      const q = new URLSearchParams();
      if (p) q.set("p", p);
      if (n) q.set("n", n);
      q.set("m", (m === "1" ? "1" : "0"));
      return "?" + q.toString();
    }

    (function initNav() {
      // Hide buttons (unchanged appearance to participants)
      const back = document.getElementById("backBtn");
      const next = document.getElementById("nextBtn");
      if (back) back.style.visibility = "hidden";
      if (next) next.style.visibility = "hidden";

      next?.addEventListener("click", () => {
        if (!NEXT_PAGE) return;
        location.href = NEXT_PAGE + baseQueryString();
      });

      back?.addEventListener("click", () => {
        if (!BACK_PAGE) return;
        location.href = BACK_PAGE + baseQueryString();
      });
    })();

    // ========= iOS zoom suppression (extra belt & braces) =========
    document.addEventListener("gesturestart", e => e.preventDefault(), { passive: false });
    // Prevent iOS Safari's double-tap zoom by short-circuiting a quick second tap.
    (function preventIOSDoubleTapZoom() {
      let lastTouchEnd = 0;
      document.addEventListener("touchend", function (e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 350) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
    })();

    // ========= Secret ABAB gesture: Top → Bottom → Top → Bottom =========
    (function initSecretGesture() {
      const REQUIRED_SEQUENCE = ["top", "bottom", "top", "bottom"];
      const WINDOW_MS = 8000; // must complete the pattern within 8s
      let progress = 0;
      let timer = null;

      const topZone = document.querySelector(".tap-top");
      const bottomZone = document.querySelector(".tap-bottom");

      if (!topZone || !bottomZone) return;

      function resetSeq() {
        progress = 0;
        if (timer) { clearTimeout(timer); timer = null; }
      }

      function armWindow() {
        if (timer) clearTimeout(timer);
        timer = setTimeout(resetSeq, WINDOW_MS);
      }

      function onTap(which, ev) {
        // Block iOS default behaviors like accidental zooms/selections
        if (ev) ev.preventDefault();

        if (REQUIRED_SEQUENCE[progress] === which) {
          if (progress === 0) armWindow();
          progress += 1;

          if (progress >= REQUIRED_SEQUENCE.length) {
            // Success! Go to /vizex-tutorial/ root with NO query params.
            const path = location.pathname;
            const match = path.match(/^(.*\/vizex-tutorial\/)/);
            const base = location.origin + (match ? match[1] : path.replace(/[^/]*$/, ''));
            location.replace(base); // no query string
            return;
          }
        } else {
          // Wrong zone; restart unless this tap matches the first step
          resetSeq();
          if (REQUIRED_SEQUENCE[0] === which) {
            progress = 1;
            armWindow();
          }
        }
      }

      // Prefer touch; fall back to click for desktop testing
      const optsActive = { passive: false };
      const optsPassive = { passive: true };

      topZone.addEventListener("touchstart", e => onTap("top", e), optsActive);
      bottomZone.addEventListener("touchstart", e => onTap("bottom", e), optsActive);

      topZone.addEventListener("click", () => onTap("top"), optsPassive);
      bottomZone.addEventListener("click", () => onTap("bottom"), optsPassive);
    })();
  </script>
</body>
</html>
