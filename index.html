<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>RESEARCHER USE ONLY — parameters input</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script src="assets/util.js" defer></script>
  <style>
    .note { font-size: 12px; opacity: .8; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; line-height:18px; }
    .pill.auto { background:#e8f5e9; color:#1b5e20; }
    .pill.manual { background:#fff3e0; color:#e65100; }
    .diag {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px; line-height: 1.45; white-space: pre-wrap;
      background: #0b0f14; color: #e6edf3; border-radius: 8px; padding: 12px;
      max-height: 220px; overflow:auto; border:1px solid #223;
    }
    .row-inline { display:flex; align-items:center; gap:8px; }
    .form-grid label .row-inline > input[type="text"] { flex: 1; }
    .btn-ghost { background:transparent; border:1px solid #999; border-radius:8px; padding:6px 10px; cursor:pointer; }
  </style>
</head>
<body data-page="index">
  <div class="page">
    <div class="content">
      <div class="inner">
        <h1>RESEARCHER USE ONLY — parameters input</h1>

        <div class="form-grid">
          <label>
            Session
            <select id="sessionSelect" aria-label="session"></select>
            <div class="note" id="sessionNote"></div>
          </label>

          <label>
            Participant preferred name (display only)
            <input type="text" id="nameInput" inputmode="text" autocomplete="off" />
          </label>

          <label>
            Participant code (saved)
            <input type="text" id="codeInput" inputmode="text" autocomplete="off" />
          </label>

          <label>
            Trial order
            <div class="row-inline">
              <input type="text" id="orderInput" inputmode="text" autocomplete="off" />
              <span id="orderModePill" class="pill auto" title="Auto-filled from session">AUTO</span>
              <button id="resetOrderBtn" class="btn-ghost" type="button" title="Reset to session default">Reset</button>
            </div>
          </label>

          <label>
            Current trial index (integer; default 0)
            <input type="text" id="indexInput" value="0" inputmode="numeric" />
          </label>

          <label>
            Mode
            <select id="modeSelect" aria-label="mode">
              <option value="0" selected>Experiment (m=0)</option>
              <option value="1">Dev mode (m=1)</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="button-bar">
        <button id="nextBtn" class="primary">Next</button>
      </div>
    </div>
  </div>

  <details style="margin:16px;">
    <summary>Diagnostics (click to expand)</summary>
    <div id="diag" class="diag" aria-live="polite"></div>
  </details>

  <script>
    /***********************
     * CONFIG + FALLBACKS  *
     ***********************/
    const FALLBACK_SESSIONS = [
      ["Friday October 17th at 9:20",  "202510170920"],
      ["Friday October 17th at 11:00", "202510171100"],
      ["Friday October 17th at 12:40", "202510171240"],
      ["Friday October 17th at 14:20", "202510171420"],
      ["Friday October 17th at 16:00", "202510171600"],
      ["Saturday October 18th at 9:20","202510180920"],
      ["Saturday October 18th at 11:00","202510181100"],
      ["Saturday October 18th at 12:40","202510181240"],
      ["Saturday October 18th at 14:20","202510181420"],
      ["Saturday October 18th at 16:00","202510181600"],
      ["Friday October 24th at 9:20",  "202510240920"],
      ["Friday October 24th at 11:00", "202510241100"],
      ["Friday October 24th at 12:40", "202510241240"],
      ["Friday October 24th at 14:20", "202510241420"],
      ["Friday October 24th at 16:00", "202510241600"],
      ["Friday October 24th at 17:40", "202510241740"],
    ];

    const SESSION_ORDERS = {
      "202510170920": "D72B2XC4534AX566311",
      "202510171100": "D42C1X166B53X253A74",
      "202510171240": "D2535X24616AX7C134B",
      "202510171420": "D514CX426235X7A3B16",
      "202510171600": "D321BX1C6255X44673A",
      "202510180920": "DB112X3436CAX764255",
      "202510181100": "D4153X24B563X267AC1",
      "202510181240": "D7165XAB1426X33C542",
      "202510181420": "D13A5X1362B2XC76454",
      "202510181600": "D5137X1C344AX622B65",
      "202510240920": "D44CBX526635XA31721",
      "202510241100": "D2326XBA7415X5C6314",
      "202510241240": "DB45CX715A23X621634",
      "202510241420": "D1526X347645XC123AB",
      "202510241600": "D51B6X47A2C3X431625",
      "202510241740": "D64A3X721B5CX245613",
    };

    /***********************
     * LOGGING UTILITIES   *
     ***********************/
    const diagEl = () => document.getElementById("diag");
    function log(...args) {
      console.log("[params-input]", ...args);
      const el = diagEl();
      if (el) el.textContent += args.map(a => {
        try { return typeof a === "string" ? a : JSON.stringify(a); }
        catch { return String(a); }
      }).join(" ") + "\n";
    }
    function hr(label="") { log("─".repeat(36) + (label ? " " + label : "")); }

    /***********************
     * READINESS HANDLER   *
     ***********************/
    function waitForVE(maxMs = 4000, stepMs = 50) {
      return new Promise((resolve) => {
        const start = performance.now();
        log("waitForVE: started, maxMs =", maxMs, "stepMs =", stepMs);

        const tick = () => {
          const ok = (window.VE && Array.isArray(window.VE.SESSIONS) && window.VE.SESSIONS.length > 0);
          if (ok) {
            log("waitForVE: VE.SESSIONS available after", Math.round(performance.now() - start), "ms.");
            return resolve({ ok: true, sessions: window.VE.SESSIONS, source: "VE.SESSIONS" });
          }
          if (performance.now() - start >= maxMs) {
            log("waitForVE: timeout; falling back to local FALLBACK_SESSIONS.");
            return resolve({ ok: false, sessions: FALLBACK_SESSIONS, source: "FALLBACK_SESSIONS" });
          }
          setTimeout(tick, stepMs);
        };
        tick();
      });
    }

    /***********************
     * MAIN INIT           *
     ***********************/
    document.addEventListener("DOMContentLoaded", async () => {
      hr("DOMContentLoaded");
      const hasVE = !!window.VE;
      log("VE present on window?", hasVE);

      // Read params; ignore empty strings later
      const params = (hasVE && typeof VE.parseParams === "function")
        ? VE.parseParams()
        : (() => {
            const o = {};
            location.search.replace(/^\?/, "").split("&").filter(Boolean).forEach(kv => {
              const [k, v=""] = kv.split("=");
              o[decodeURIComponent(k)] = decodeURIComponent(v);
            });
            return o;
          })();

      log("Query params:", params);

      // Elements
      const sel           = document.getElementById("sessionSelect");
      const nameInput     = document.getElementById("nameInput");
      const codeInput     = document.getElementById("codeInput");
      const orderInput    = document.getElementById("orderInput");
      const indexInput    = document.getElementById("indexInput");
      const modeSelect    = document.getElementById("modeSelect");
      const nextBtn       = document.getElementById("nextBtn");
      const sessionNote   = document.getElementById("sessionNote");
      const orderModePill = document.getElementById("orderModePill");
      const resetOrderBtn = document.getElementById("resetOrderBtn");

      // Manual/Auto state (default AUTO)
      let manualOrderOverride = false;

      function setOrderPill(manual) {
        manualOrderOverride = !!manual;
        orderModePill.textContent = manual ? "MANUAL" : "AUTO";
        orderModePill.classList.toggle("manual", manual);
        orderModePill.classList.toggle("auto", !manual);
      }

      function applyDefaultOrderIfAllowed() {
        const sessionCode = sel.value;
        const defaultOrder = SESSION_ORDERS[sessionCode] || "";
        log("applyDefaultOrderIfAllowed: manual?", manualOrderOverride, "| session:", sessionCode, "| default:", defaultOrder);
        if (!manualOrderOverride) {
          orderInput.value = defaultOrder;
          log("→ orderInput set to default for session.");
        } else {
          log("→ manual override in effect; leaving orderInput unchanged.");
        }
      }

      const ready = await waitForVE();
      log("Sessions source:", ready.source, "| count:", ready.sessions.length);
      sessionNote.textContent = ''; //`Source: ${ready.source} (count: ${ready.sessions.length})`;

      // Populate sessions
      sel.innerHTML = "";
      ready.sessions.forEach(([label, code]) => {
        const opt = document.createElement("option");
        opt.value = code; opt.textContent = label;
        sel.appendChild(opt);
      });
      log("Session select populated.");

      // Prefill (ignore blank strings)
      if (params.s && params.s.trim() !== "") { sel.value = params.s; log("Prefill: s =", params.s); }
      if (params.n && params.n.trim() !== "") { nameInput.value = params.n; log("Prefill: n =", params.n); }
      if (params.p && params.p.trim() !== "") { codeInput.value = params.p; log("Prefill: p =", params.p); }
      if (params.i && params.i.trim() !== "") { indexInput.value = params.i; log("Prefill: i =", params.i); }
      if (params.m && params.m.trim() !== "") { modeSelect.value = params.m; log("Prefill: m =", params.m); }

      // If session is still unset (empty param), default to first option
      if (!sel.value && sel.options.length > 0) {
        sel.value = sel.options[0].value;
        log("No session in query; defaulting to first session:", sel.value);
      }

      // INITIAL MODE: AUTO unless t is a non-empty string
      const hasManualT = (typeof params.t === "string" && params.t.trim().length > 0);
      if (hasManualT) {
        orderInput.value = params.t.trim();
        setOrderPill(true); // MANUAL
        log("Prefill: t (manual override) =", params.t.trim());
      } else {
        setOrderPill(false); // AUTO
        log("No non-empty t provided; starting in AUTO mode.");
        applyDefaultOrderIfAllowed(); // auto-fill from selected session
      }

      // Handlers
      sel.addEventListener("change", () => {
        log("Session changed to", sel.value);
        applyDefaultOrderIfAllowed();
      });

      orderInput.addEventListener("input", () => {
        if (!manualOrderOverride) {
          log("orderInput edited by user → switching to MANUAL mode.");
          setOrderPill(true);
        } else {
          log("orderInput edited while already MANUAL.");
        }
      });

      resetOrderBtn.addEventListener("click", () => {
        log("Reset button clicked → switching to AUTO and applying default.");
        setOrderPill(false);
        applyDefaultOrderIfAllowed();
      });

      nextBtn.addEventListener("click", () => {
        const nextParams = {
          p: (codeInput.value || "").trim(),
          n: (nameInput.value || "").trim(),
          s: sel.value,
          t: (orderInput.value || "").trim(),
          i: String(parseInt(indexInput.value || "0", 10) || 0),
          m: modeSelect.value
        };
        log("Next clicked → VE.goto with:", nextParams);

        if (window.VE && typeof VE.goto === "function") {
          VE.goto("param-check.html", nextParams);
        } else {
          const qs = Object.entries(nextParams)
            .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
          const url = `param-check.html?${qs}`;
          log("VE.goto not available; fallback to location.href =", url);
          location.href = url;
        }
      });

      if (window.VE && typeof VE.renderDevFooter === "function") {
        log("Rendering dev footer…");
        VE.renderDevFooter(params, "index");
      } else {
        log("VE.renderDevFooter unavailable (skipped).");
      }

      hr("Init complete");
    });
  </script>
</body>
</html>
